# Simplified Clustering Results - Data Extraction Guide

## Overview

This document explains how to load and extract data from the simplified clustering results files generated by `Unit_Feature_Comprehensive_Heatmap.m`.

**File naming convention:**
- `simplified_clustering_Aversive_[timestamp].mat` - Aversive session clustering
- `simplified_clustering_Reward_[timestamp].mat` - Reward session clustering
- `simplified_clustering_combined_[timestamp].mat` - Combined session clustering

---

## Quick Start

### Load the Data

```matlab
% Load the saved clustering results
load('simplified_clustering_Aversive_2025-01-15_143022.mat');

% All data is stored in: simplified_clustering_results
% Check what's inside
disp(fieldnames(simplified_clustering_results));
```

---

## Data Structure

The `simplified_clustering_results` structure contains 8 main sections:

### 1. **clustering** - Hierarchical Clustering Information
```matlab
.clustering.linkage_tree          % Linkage tree for dendrogram (N-1 x 3)
.clustering.cluster_threshold     % Distance threshold used for cutting tree
.clustering.cluster_assignments   % Cluster ID for each unit (N x 1)
.clustering.n_clusters            % Total number of clusters found
.clustering.cluster_double_sort   % Unit order for sorted visualization
.clustering.simple_sort_idx       % Original dendrogram leaf order
.clustering.valid_units           % Boolean array of units included
.clustering.distances             % Pairwise distance matrix
```

### 2. **features** - Feature Matrix Data
```matlab
.features.matrix                  % Original feature matrix (N x F)
.features.matrix_sorted           % Matrix sorted by cluster (N x F)
.features.names                   % Cell array of feature names
.features.valid_features          % Indices of features used
.features.simplified_indices      % Feature indices in full feature matrix
```

### 3. **units** - Per-Unit Metadata
```matlab
.units(i).global_unit_id          % Unique unit identifier
.units(i).session_id              % Session this unit belongs to
.units(i).unit_id                 % Unit index within session
.units(i).is_aversive             % Boolean: true if aversive session
.units(i).cluster_id              % Cluster assignment
.units(i).features                % Feature values for this unit (1 x F)
.units(i).session_filename        % Original data filename
.units(i).session_type            % 'Aversive' or 'Reward'
```

### 4. **session_composition** - Session-Cluster Statistics
```matlab
.session_composition.session_cluster_matrix  % Sessions x Clusters count matrix
.session_composition.unique_sessions         % Array of unique session IDs
.session_composition.n_sessions              % Total number of sessions
.session_composition.cluster_stats           % Detailed stats per cluster
.session_composition.units_per_session       % Total units per session
```

### 5. **visualization** - Data for Plotting
```matlab
.visualization.is_aversive_sorted       % Session types in sorted order
.visualization.simple_session_ids       % Session ID per unit
.visualization.simple_is_aversive       % Aversive flag per unit
```

### 6. **metadata** - Analysis Configuration
```matlab
.metadata.timestamp                % When analysis was performed
.metadata.feature_names            % Names of features used
.metadata.n_features               % Number of features
.metadata.config                   % Full configuration structure
.metadata.session_type             % 'Aversive', 'Reward', or 'combined'
```

### 7. **data_paths** - Paths to Original Data
```matlab
.data_paths.feature_file           % Path to unit_features_comprehensive.mat
.data_paths.spike_data_folder      % Path to raw spike data folder
```

### 8. **cluster_lookup** - Per-Cluster Information
```matlab
.cluster_lookup(c).cluster_id              % Cluster identifier
.cluster_lookup(c).unit_indices            % Global unit indices in this cluster
.cluster_lookup(c).n_units                 % Number of units
.cluster_lookup(c).unit_details            % Array of detailed unit info
.cluster_lookup(c).unit_details(i).global_unit_id
.cluster_lookup(c).unit_details(i).session_id
.cluster_lookup(c).unit_details(i).session_filename
.cluster_lookup(c).unit_details(i).unit_id
.cluster_lookup(c).unit_details(i).session_type
.cluster_lookup(c).centroid                % Mean feature values (1 x F)
```

---

## Common Use Cases

### 1. Get Basic Information

```matlab
load('simplified_clustering_Aversive_2025-01-15_143022.mat');
results = simplified_clustering_results;

% How many clusters?
n_clusters = results.clustering.n_clusters;
fprintf('Found %d clusters\n', n_clusters);

% What features were used?
features = results.features.names;
fprintf('Features: %s\n', strjoin(features, ', '));

% How many units total?
n_units = length(results.units);
fprintf('Total units: %d\n', n_units);

% When was this analysis done?
fprintf('Analysis timestamp: %s\n', results.metadata.timestamp);
```

### 2. Get All Units in a Specific Cluster

```matlab
% Get all units in cluster 3
cluster_id = 3;
cluster_info = results.cluster_lookup(cluster_id);

fprintf('Cluster %d contains %d units\n', cluster_id, cluster_info.n_units);

% Access unit details
for i = 1:cluster_info.n_units
    unit = cluster_info.unit_details(i);
    fprintf('  Unit %d: Session %d, Unit ID %d (%s)\n', ...
        unit.global_unit_id, unit.session_id, unit.unit_id, unit.session_type);
end

% Get cluster centroid (mean features)
centroid = cluster_info.centroid;
fprintf('Cluster centroid features: ');
fprintf('%.3f ', centroid);
fprintf('\n');
```

### 3. Compare Two Clusters

```matlab
% Compare clusters 2 and 5
cluster1 = results.cluster_lookup(2);
cluster2 = results.cluster_lookup(5);

fprintf('Cluster 2: %d units, Cluster 5: %d units\n', ...
    cluster1.n_units, cluster2.n_units);

% Compare centroids
centroid_distance = pdist([cluster1.centroid; cluster2.centroid], 'euclidean');
fprintf('Distance between centroids: %.3f\n', centroid_distance);

% Get feature names for interpretation
feature_names = results.features.names;
fprintf('\nFeature comparison:\n');
for f = 1:length(feature_names)
    fprintf('  %s: Cluster2=%.3f, Cluster5=%.3f, diff=%.3f\n', ...
        feature_names{f}, cluster1.centroid(f), cluster2.centroid(f), ...
        cluster1.centroid(f) - cluster2.centroid(f));
end
```

### 4. Find Which Cluster a Specific Unit Belongs To

```matlab
% Find cluster for unit with global_unit_id = 42
global_unit_id = 42;

unit_idx = find([results.units.global_unit_id] == global_unit_id);
if ~isempty(unit_idx)
    unit = results.units(unit_idx);
    fprintf('Unit %d is in cluster %d\n', global_unit_id, unit.cluster_id);
    fprintf('  Session: %d (%s)\n', unit.session_id, unit.session_type);
    fprintf('  Features: ');
    fprintf('%.3f ', unit.features);
    fprintf('\n');
else
    fprintf('Unit %d not found\n', global_unit_id);
end
```

### 5. Analyze Session Contribution to Clusters

```matlab
% Which sessions contribute most to cluster 3?
cluster_id = 3;

session_cluster_matrix = results.session_composition.session_cluster_matrix;
unique_sessions = results.session_composition.unique_sessions;

% Get units from each session in this cluster
units_per_session = session_cluster_matrix(:, cluster_id);

fprintf('Session contribution to Cluster %d:\n', cluster_id);
for s = 1:length(unique_sessions)
    if units_per_session(s) > 0
        fprintf('  Session %d: %d units\n', unique_sessions(s), units_per_session(s));
    end
end
```

### 6. Get Units from a Specific Session

```matlab
% Get all units from session 15
target_session = 15;

session_units = results.units([results.units.session_id] == target_session);
fprintf('Session %d has %d units\n', target_session, length(session_units));

% Group by cluster
for c = 1:results.clustering.n_clusters
    cluster_units = session_units([session_units.cluster_id] == c);
    if ~isempty(cluster_units)
        fprintf('  Cluster %d: %d units\n', c, length(cluster_units));
    end
end
```

---

## Advanced Use Cases

### 7. Load Raw Spike Data for a Cluster

```matlab
% Get spike data for all units in cluster 4
cluster_id = 4;
cluster_units = results.cluster_lookup(cluster_id).unit_details;

% Load sorting parameters
[T_sorted] = loadSortingParameters();

% Process each unique session
unique_sessions = unique({cluster_units.session_filename});

for sess_idx = 1:length(unique_sessions)
    session_file = unique_sessions{sess_idx};
    fprintf('Loading %s\n', session_file);

    % Find the file
    spike_folder = results.data_paths.spike_data_folder;
    session_struct = dir(fullfile(spike_folder, session_file));

    if isempty(session_struct)
        fprintf('  File not found\n');
        continue;
    end

    % Load spike data
    Timelimits = 'No';
    [~, ~, ~, ~, ~, ~, ~, ~, ~, ~, valid_spikes, ~, TriggerMid] = ...
        loadAndPrepareSessionData(session_struct, T_sorted, Timelimits);

    % Get units from this session that are in our cluster
    session_cluster_units = cluster_units(strcmp({cluster_units.session_filename}, session_file));

    for i = 1:length(session_cluster_units)
        unit_id = session_cluster_units(i).unit_id;
        spike_times = valid_spikes{unit_id};

        fprintf('  Unit %d: %d spikes\n', unit_id, length(spike_times));

        % Now you can analyze spike_times
        % e.g., compute firing rate, ISI, etc.
    end
end
```

### 8. Compute Cross-Correlations Between Clusters

```matlab
% Compute cross-correlation between neurons in cluster 2 and cluster 5
% This is a template - you'll need to implement the actual cross-correlation

cluster1_units = results.cluster_lookup(2).unit_details;
cluster2_units = results.cluster_lookup(5).unit_details;

fprintf('Computing cross-correlations between Cluster 2 (%d units) and Cluster 5 (%d units)\n', ...
    length(cluster1_units), length(cluster2_units));

% Load spike data for both clusters
% (use code from example 7 above)

% For each pair of units (one from each cluster):
% 1. Align to same time base
% 2. Compute cross-correlation
% 3. Store results

% Example structure:
% cross_corr_matrix = zeros(length(cluster1_units), length(cluster2_units));
% for i = 1:length(cluster1_units)
%     for j = 1:length(cluster2_units)
%         cross_corr_matrix(i,j) = computeCrossCorr(spike_times1{i}, spike_times2{j});
%     end
% end
```

---

## Regenerate Original Figures

### Figure 1: Session ID Composition Figure

```matlab
load('simplified_clustering_Aversive_2025-01-15_143022.mat');
results = simplified_clustering_results;

% Extract variables
linkage_tree = results.clustering.linkage_tree;
cluster_threshold = results.clustering.cluster_threshold;
cluster_assignments = results.clustering.cluster_assignments;
cluster_double_sort = results.clustering.cluster_double_sort;
session_cluster_matrix = results.session_composition.session_cluster_matrix;
unique_sessions = results.session_composition.unique_sessions;
n_sessions = results.session_composition.n_sessions;
n_clusters = results.clustering.n_clusters;
simple_session_ids = results.visualization.simple_session_ids;
simple_is_aversive = results.visualization.simple_is_aversive;

% Create figure
fig_composition = figure('Position', [200 200 1600 800], ...
    'Name', 'Cluster Session ID Composition');

% LEFT: Colored Dendrogram
subplot('Position', [0.05 0.12 0.18 0.75]);
H = dendrogram(linkage_tree, 0, 'Orientation', 'left', ...
    'ColorThreshold', cluster_threshold, ...
    'Reorder', cluster_double_sort);
set(gca, 'YDir', 'normal');
set(gca, 'XTickLabel', []);
ylabel('Units (sorted by Cluster ID)', 'FontSize', 11, 'FontWeight', 'bold');
title('Dendrogram', 'FontSize', 12, 'FontWeight', 'bold');
set(gca, 'FontSize', 10);
hold on;
ylims = ylim;
plot([cluster_threshold, cluster_threshold], ylims, 'r--', 'LineWidth', 2);
hold off;
box on;

% CENTER: Session-Cluster Heatmap
subplot('Position', [0.28 0.12 0.35 0.75]);
imagesc(session_cluster_matrix');
colormap(gca, hot);
cb = colorbar('Position', [0.64 0.12 0.015 0.75]);
ylabel(cb, 'Unit Count', 'FontSize', 10);
xlabel('Session ID', 'FontSize', 11, 'FontWeight', 'bold');
ylabel('Cluster ID', 'FontSize', 11, 'FontWeight', 'bold');
title('Units per Session per Cluster', 'FontSize', 12, 'FontWeight', 'bold');
set(gca, 'XTick', 1:n_sessions);
set(gca, 'XTickLabel', unique_sessions);
set(gca, 'XTickLabelRotation', 45);
set(gca, 'YTick', 1:n_clusters);
set(gca, 'YTickLabel', 1:n_clusters);
set(gca, 'YDir', 'normal');
set(gca, 'FontSize', 10);
axis tight;

% Add count labels
for s = 1:n_sessions
    for c = 1:n_clusters
        count = session_cluster_matrix(s, c);
        if count > 0
            if count > max(session_cluster_matrix(:)) * 0.5
                text_color = 'white';
            else
                text_color = 'black';
            end
            text(s, c, num2str(count), 'HorizontalAlignment', 'center', ...
                'Color', text_color, 'FontSize', 9, 'FontWeight', 'bold');
        end
    end
end

% RIGHT: Bar chart
subplot('Position', [0.70 0.12 0.25 0.75]);
units_per_session = sum(session_cluster_matrix, 2);
bar_colors = zeros(n_sessions, 3);
for s = 1:n_sessions
    sess_id = unique_sessions(s);
    unit_idx = find(ismember(simple_session_ids, sess_id), 1);
    if ~isempty(unit_idx) && simple_is_aversive(unit_idx)
        bar_colors(s, :) = [0.8 0.2 0.2];  % Red for aversive
    else
        bar_colors(s, :) = [0.2 0.2 0.8];  % Blue for reward
    end
end
bar_handle = bar(1:n_sessions, units_per_session, 'FaceColor', 'flat');
bar_handle.CData = bar_colors;
xlabel('Session ID', 'FontSize', 11, 'FontWeight', 'bold');
ylabel('Total Units', 'FontSize', 11, 'FontWeight', 'bold');
title('Units per Session', 'FontSize', 12, 'FontWeight', 'bold');
set(gca, 'XTick', 1:n_sessions);
set(gca, 'XTickLabel', unique_sessions);
set(gca, 'XTickLabelRotation', 45);
set(gca, 'FontSize', 10);
grid on;

% Add legend
hold on;
h_aversive = plot(nan, nan, 's', 'MarkerSize', 10, 'MarkerFaceColor', [0.8 0.2 0.2], 'MarkerEdgeColor', 'none');
h_reward = plot(nan, nan, 's', 'MarkerSize', 10, 'MarkerFaceColor', [0.2 0.2 0.8], 'MarkerEdgeColor', 'none');
legend([h_aversive, h_reward], {'Aversive', 'Reward'}, 'Location', 'best', 'FontSize', 9);
hold off;

sgtitle(sprintf('Session ID Composition (%d clusters, %d sessions, threshold=%.2f)', ...
    n_clusters, n_sessions, cluster_threshold), 'FontSize', 14, 'FontWeight', 'bold');
```

### Figure 2: Sorted Heatmap with Dendrogram

```matlab
load('simplified_clustering_Aversive_2025-01-15_143022.mat');
results = simplified_clustering_results;

% Extract variables
linkage_tree = results.clustering.linkage_tree;
cluster_threshold = results.clustering.cluster_threshold;
cluster_double_sort = results.clustering.cluster_double_sort;
simple_matrix_sorted = results.features.matrix_sorted;
simple_names_used = results.features.names;
is_aversive_sorted = results.visualization.is_aversive_sorted;
valid_features = results.features.valid_features;

% Get sorted matrix with only valid features
simple_matrix_sorted = simple_matrix_sorted(:, valid_features);

% Create figure
fig_simple = figure('Position', [100 100 1600 1000], ...
    'Name', 'Simplified Clustering Heatmap');

% LEFT: Dendrogram
subplot('Position', [0.05 0.15 0.10 0.75]);
dendrogram(linkage_tree, 0, 'Orientation', 'left', ...
    'ColorThreshold', cluster_threshold, ...
    'Reorder', cluster_double_sort);
set(gca, 'YDir', 'reverse');
set(gca, 'XTickLabel', []);
ylabel('Units');
title('Unit Clustering');

% CENTER: Heatmap
subplot('Position', [0.17 0.15 0.65 0.75]);
imagesc(simple_matrix_sorted);
axis tight;
colormap(bluewhitered(256));
caxis([-3 3]);

cb = colorbar;
cb.Position = [0.84 0.15 0.02 0.75];
ylabel(cb, 'Z-score', 'FontSize', 11);

xlabel('Features', 'FontSize', 12, 'FontWeight', 'bold');
ylabel('Units', 'FontSize', 12, 'FontWeight', 'bold');

set(gca, 'XTick', 1:length(simple_names_used));
set(gca, 'XTickLabel', simple_names_used);
set(gca, 'XTickLabelRotation', 45);
set(gca, 'FontSize', 11);
set(gca, 'YTick', []);

% LEFT color bar for session type
subplot('Position', [0.15 0.15 0.01 0.75]);
session_type_colors = zeros(length(is_aversive_sorted), 1, 3);
for i = 1:length(is_aversive_sorted)
    if is_aversive_sorted(i)
        session_type_colors(i, 1, :) = [0.8 0.2 0.2];  % Red
    else
        session_type_colors(i, 1, :) = [0.2 0.2 0.8];  % Blue
    end
end
image(session_type_colors);
set(gca, 'XTick', [], 'YTick', []);
xlabel('Session', 'FontSize', 9, 'Rotation', 0);

title_str = sprintf('Simplified Clustering (%d units)', size(simple_matrix_sorted, 1));
annotation('textbox', [0.17 0.92 0.65 0.05], 'String', title_str, ...
    'EdgeColor', 'none', 'FontSize', 14, 'FontWeight', 'bold', ...
    'HorizontalAlignment', 'center');
```

---

## Feature Names Reference

The actual feature names vary depending on which features were included in the simplified clustering. Check `results.features.names` to see what was used.

**Typical features:**
- `Coh_5-7Hz` - Spike-LFP coherence in 5-7 Hz band
- `Coh_8-10Hz` - Spike-LFP coherence in 8-10 Hz band
- `PSTH_WP1_MeanZ` - Mean Z-score response in WP1 period
- `PSTH_WP2_MeanZ` - Mean Z-score response in WP2 period
- `PSTH_Aversive_MeanZ` - Mean Z-score response to aversive stimulus
- `FiringRate` - Mean firing rate (Hz)

---

## Configuration Information

Access the full configuration used for the analysis:

```matlab
config = results.metadata.config;

% Key configuration parameters:
config.cluster_dimension          % 'units', 'features', or 'both'
config.exclude_categories         % Which feature categories were excluded
config.separate_by_session        % true/false
config.simplified_cluster_threshold  % Distance threshold used
config.exclude_sessions           % Which sessions were excluded
```

---

## Notes for Future Analysis

### Cluster Interaction Analysis

To analyze interactions between clusters:

1. **Load spike data** for units in each cluster (see example 7)
2. **Align temporal data** to common time base (use TriggerMid)
3. **Compute metrics:**
   - Cross-correlations between spike trains
   - Coherence between clusters
   - Synchrony measures (e.g., spike-field coherence)
   - Phase relationships

### Statistical Comparisons

Compare clusters using:
- `cluster_lookup(c).centroid` - Mean feature values per cluster
- Perform t-tests or ANOVA on feature differences
- Use `session_composition` data to test session effects

### Visualization Tips

- Use `cluster_assignments` to color-code units by cluster
- Use `cluster_double_sort` to maintain consistent ordering across plots
- Color aversive vs reward using `is_aversive` fields

---

## Troubleshooting

**Q: How do I know which clustering file to use?**
A: Check the filename suffix (`_Aversive_`, `_Reward_`, or `_combined_`) and the timestamp.

**Q: The spike data path doesn't exist on my system**
A: Update the path in your analysis script:
```matlab
results.data_paths.spike_data_folder = '/your/new/path';
```

**Q: How do I find units from a specific session in a specific cluster?**
A: Filter by both:
```matlab
cluster_id = 3;
session_id = 15;
units = results.units([results.units.cluster_id] == cluster_id & ...
                      [results.units.session_id] == session_id);
```

---

## Version Information

**Generated by:** `Unit_Feature_Comprehensive_Heatmap.m`
**Analysis date:** Check `results.metadata.timestamp`
**MATLAB version:** R2019b or later recommended

---

## Contact

For questions about data structure or analysis methods, consult the original analysis script:
`Unit_Feature_Comprehensive_Heatmap.m`
